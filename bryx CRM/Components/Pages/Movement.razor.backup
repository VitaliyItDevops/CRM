@page "/movement"
@rendermode InteractiveServer
@using bryx_CRM.Data
@using bryx_CRM.Data.Models
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory

<PageTitle>–î–≤–∏–∂–µ–Ω–∏–µ</PageTitle>

<h3>–î–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</h3>

@if (sales == null)
{
    <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
}
else if (!sales.Any())
{
    <p class="no-sales">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ø—É—Ç–∏</p>
}
else
{
    <div class="sales-list">
        @foreach (var sale in sales)
        {
            <div class="sale-card @(expandedSaleId == sale.Id ? "expanded" : "")">
                <div class="sale-header" @onclick="@(() => ToggleExpand(sale.Id))">
                    <div class="sale-info">
                        <h4>@(!string.IsNullOrEmpty(sale.SoldThrough) ? sale.SoldThrough : "–ü—Ä—è–º–∞—è –ø—Ä–æ–¥–∞–∂–∞") ‚Ä¢ @sale.Buyer ‚Ä¢ @sale.TotalAmount.ToString("N0") ‚ÇΩ</h4>
                        <div class="sale-details">
                            <span><strong>–î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏:</strong> @sale.SaleDate.ToLocalTime().ToString("dd.MM.yyyy")</span>
                            @if (!string.IsNullOrEmpty(sale.TTN))
                            {
                                <span><strong>–¢–¢–ù:</strong> @sale.TTN</span>
                            }
                            <span class="status-badge status-@sale.Status.ToLower()">@sale.Status</span>
                        </div>
                    </div>
                    <div class="expand-icon">
                        @if (expandedSaleId == sale.Id)
                        {
                            <span>‚ñº</span>
                        }
                        else
                        {
                            <span>‚ñ∂</span>
                        }
                    </div>
                </div>

                @if (expandedSaleId == sale.Id)
                {
                    <div class="sale-content">
                        <h5>–¢–æ–≤–∞—Ä—ã –≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–∏:</h5>
                        <div class="products-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                        <th>–¶–≤–µ—Ç</th>
                                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                        <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                        <th>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var product in sale.Products)
                                    {
                                        <tr class="@(product.Status == "–í–æ–∑–≤—Ä–∞—Ç" ? "product-return-row" : "")">
                                            <td>@product.Name</td>
                                            <td>@(product.Color ?? "-")</td>
                                            <td>@product.Category</td>
                                            <td>@product.Supplier</td>
                                            <td>@product.SalePrice.ToString("N0") ‚ÇΩ</td>
                                            <td>
                                                <span class="product-status-badge @GetProductStatusClass(product.Status)">
                                                    @product.Status
                                                </span>
                                            </td>
                                            <td>
                                                @if (product.Status == "–í–æ–∑–≤—Ä–∞—Ç")
                                                {
                                                    <button class="btn-mark-received-small" @onclick="@(() => MarkReturnAsReceived(product))" @onclick:stopPropagation="true">
                                                        ‚úì –ü–æ–ª—É—á–µ–Ω–æ
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        @* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–û–∂–∏–¥–∞–µ—Ç" *@
                        @if (sale.Status == "–û–∂–∏–¥–∞–µ—Ç")
                        {
                            <div class="actions-section">
                                <button class="btn-ship" @onclick="@(() => MarkAsShipped(sale))">
                                    üì¶ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                </button>
                            </div>
                        }

                        @* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" *@
                        @if (sale.Status == "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
                        {
                            <div class="actions-section">
                                <button class="btn-confirm" @onclick="@(() => ShowConfirmDeliveryModal(sale))">
                                    ‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ
                                </button>
                                <button class="btn-return" @onclick="@(() => ShowReturnModal(sale))">
                                    ‚Ü© –û—Ñ–æ—Ä–º–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
}

@* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è *@
@if (showConfirmDeliveryModal && selectedSale != null)
{
    <div class="modal-overlay" @onclick="CloseConfirmDeliveryModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h4>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h4>

            <div class="sale-summary">
                <p><strong>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å:</strong> @selectedSale.Buyer</p>
                <p><strong>–¢–æ–≤–∞—Ä–æ–≤:</strong> @selectedSale.Products.Count —à—Ç.</p>
                <p><strong>–°—É–º–º–∞:</strong> @selectedSale.TotalAmount.ToString("N0") ‚ÇΩ</p>
            </div>

            <p class="warning-text">–í—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª –≤—Å–µ —Ç–æ–≤–∞—Ä—ã?</p>

            @if (!string.IsNullOrEmpty(confirmError))
            {
                <div class="error-message">@confirmError</div>
            }

            <div class="modal-actions">
                <button class="btn-cancel" @onclick="CloseConfirmDeliveryModal">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-save" @onclick="ConfirmDelivery">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>
}

@* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ *@
@if (showReturnModal && selectedSale != null)
{
    <div class="modal-overlay" @onclick="CloseReturnModal">
        <div class="modal-content large" @onclick:stopPropagation="true">
            <h4>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞</h4>

            <div class="sale-summary">
                <p><strong>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å:</strong> @selectedSale.Buyer</p>
                <p><strong>–î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏:</strong> @selectedSale.SaleDate.ToLocalTime().ToString("dd.MM.yyyy")</p>
            </div>

            <h5>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞:</h5>
            <div class="return-products-list">
                @foreach (var product in selectedSale.Products)
                {
                    <div class="return-product-item">
                        <label class="checkbox-label">
                            <input type="checkbox"
                                   checked="@returnSelectedProducts.Contains(product.Id)"
                                   @onchange="@(() => ToggleReturnProduct(product.Id))" />
                            <div class="product-info">
                                <strong>@product.Name</strong>
                                @if (!string.IsNullOrEmpty(product.Color))
                                {
                                    <span class="product-color">(@product.Color)</span>
                                }
                                <span class="product-price">- @product.SalePrice.ToString("N0") ‚ÇΩ</span>
                            </div>
                        </label>
                    </div>
                }
            </div>

            <div class="return-actions">
                <button class="btn-select-all" @onclick="SelectAllProducts">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                <button class="btn-deselect-all" @onclick="DeselectAllProducts">–°–Ω—è—Ç—å –≤—Å–µ</button>
            </div>

            @if (!string.IsNullOrEmpty(returnError))
            {
                <div class="error-message">@returnError</div>
            }

            <div class="modal-actions">
                <button class="btn-cancel" @onclick="CloseReturnModal">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-return-confirm"
                        @onclick="ProcessReturn"
                        disabled="@(!returnSelectedProducts.Any())">
                    –û—Ñ–æ—Ä–º–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç (@returnSelectedProducts.Count —à—Ç.)
                </button>
            </div>
        </div>
    </div>
}

<style>
    .no-sales {
        text-align: center;
        color: #6c757d;
        padding: 40px;
        font-style: italic;
    }

    .sales-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .sale-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }

        .sale-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .sale-card.expanded {
            border-color: #667eea;
        }

    .sale-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        cursor: pointer;
        transition: background 0.2s ease;
    }

        .sale-header:hover {
            background: #f8f9fa;
        }

    .sale-info h4 {
        margin: 0 0 10px 0;
        color: #212529;
        font-size: 18px;
    }

    .sale-details {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        font-size: 14px;
        color: #6c757d;
    }

    .expand-icon {
        font-size: 20px;
        color: #667eea;
        font-weight: bold;
    }

    .sale-content {
        padding: 0 20px 20px 20px;
        border-top: 1px solid #dee2e6;
        animation: slideDown 0.3s ease;
    }

    @@keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .sale-content h5 {
        margin: 15px 0 10px 0;
        color: #495057;
        font-size: 16px;
    }

    .products-table {
        overflow-x: auto;
        margin-bottom: 20px;
    }

        .products-table table {
            width: 100%;
            border-collapse: collapse;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .products-table thead {
            background: #e9ecef;
        }

        .products-table th {
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            font-size: 13px;
            border-bottom: 2px solid #dee2e6;
        }

        .products-table td {
            padding: 10px;
            color: #212529;
            font-size: 14px;
            border-bottom: 1px solid #dee2e6;
        }

        .products-table tbody tr:last-child td {
            border-bottom: none;
        }

    .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-badge.status-–æ–∂–∏–¥–∞–µ—Ç {
        background: #cfe2ff;
        color: #084298;
    }

    .status-badge.status-–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {
        background: #fff3cd;
        color: #856404;
    }

    .status-badge.status-–ø–æ–ª—É—á–µ–Ω–æ {
        background: #d1e7dd;
        color: #0f5132;
    }

    .status-badge.status-–≤–æ–∑–≤—Ä–∞—Ç {
        background: #f8d7da;
        color: #842029;
    }

    .product-status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .product-status-badge.status-–æ–∂–∏–¥–∞–µ—Ç {
        background: #cfe2ff;
        color: #084298;
    }

    .product-status-badge.status-–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {
        background: #fff3cd;
        color: #856404;
    }

    .product-status-badge.status-–≤–æ–∑–≤—Ä–∞—Ç {
        background: #f8d7da;
        color: #842029;
    }

    .product-status-badge.status-–ø—Ä–æ–¥–∞–Ω–æ {
        background: #d1e7dd;
        color: #0f5132;
    }

    .product-return-row {
        background: #fff5f5 !important;
    }

    .btn-mark-received-small {
        background: #198754;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

        .btn-mark-received-small:hover {
            background: #157347;
            transform: scale(1.05);
        }

    .actions-section {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .btn-confirm {
        background: #198754;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

        .btn-confirm:hover {
            background: #157347;
            transform: scale(1.02);
        }

    .btn-return {
        background: #fd7e14;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

        .btn-return:hover {
            background: #e36209;
            transform: scale(1.02);
        }

    .btn-ship {
        background: #0d6efd;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

        .btn-ship:hover {
            background: #0b5ed7;
            transform: scale(1.02);
        }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-height: 90vh;
        overflow-y: auto;
    }

        .modal-content.large {
            max-width: 700px;
        }

        .modal-content h4 {
            margin: 0 0 20px 0;
            color: #212529;
        }

        .modal-content h5 {
            margin: 20px 0 10px 0;
            color: #495057;
            font-size: 16px;
        }

    .sale-summary {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

        .sale-summary p {
            margin: 5px 0;
            color: #495057;
        }

    .warning-text {
        color: #856404;
        background: #fff3cd;
        padding: 12px;
        border-radius: 5px;
        border: 1px solid #ffecb5;
        margin-bottom: 20px;
    }

    .return-products-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        background: #f8f9fa;
    }

    .return-product-item {
        padding: 10px;
        background: white;
        border-radius: 5px;
        margin-bottom: 8px;
        border: 1px solid #dee2e6;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
    }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

    .product-info {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .product-color {
        color: #9933cc;
        font-weight: 500;
    }

    .product-price {
        color: #198754;
        font-weight: 600;
    }

    .return-actions {
        display: flex;
        gap: 10px;
        margin: 15px 0;
    }

    .btn-select-all, .btn-deselect-all {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
    }

    .btn-select-all {
        background: #0d6efd;
        color: white;
    }

        .btn-select-all:hover {
            background: #0b5ed7;
        }

    .btn-deselect-all {
        background: #6c757d;
        color: white;
    }

        .btn-deselect-all:hover {
            background: #5a6268;
        }

    .error-message {
        background: #f8d7da;
        color: #842029;
        padding: 12px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid #f5c2c7;
        font-size: 14px;
        font-weight: 500;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }

    .btn-cancel, .btn-save, .btn-return-confirm {
        padding: 10px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
    }

    .btn-cancel {
        background: #6c757d;
        color: white;
    }

        .btn-cancel:hover {
            background: #5a6268;
        }

    .btn-save {
        background: #198754;
        color: white;
    }

        .btn-save:hover {
            background: #157347;
        }

    .btn-return-confirm {
        background: #fd7e14;
        color: white;
    }

        .btn-return-confirm:hover {
            background: #e36209;
        }

        .btn-return-confirm:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
</style>

@code {
    private List<Sale>? sales = null;
    private int? expandedSaleId = null;

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è
    private bool showConfirmDeliveryModal = false;
    private Sale? selectedSale = null;
    private string confirmError = "";

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–æ–∑–≤—Ä–∞—Ç–∞
    private bool showReturnModal = false;
    private HashSet<int> returnSelectedProducts = new HashSet<int>();
    private string returnError = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadSales();
    }

    private async Task LoadSales()
    {
        using var context = await DbContextFactory.CreateDbContextAsync();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–¥–∞–∂–∏
        sales = await context.Sales
            .Where(s => s.Status == "–û–∂–∏–¥–∞–µ—Ç" || s.Status == "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" || s.Status == "–í–æ–∑–≤—Ä–∞—Ç" || s.Status == "–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç")
            .OrderByDescending(s => s.SaleDate)
            .ToListAsync();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–π –ø—Ä–æ–¥–∞–∂–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
        var saleIds = sales.Select(s => s.Id).ToList();
        var products = await context.Products
            .Where(p => p.SaleId != null && saleIds.Contains(p.SaleId.Value))
            .ToListAsync();

        // –°–≤—è–∑—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å –ø—Ä–æ–¥–∞–∂–∞–º–∏ –≤—Ä—É—á–Ω—É—é
        foreach (var sale in sales)
        {
            sale.Products = products.Where(p => p.SaleId == sale.Id).ToList();
        }

        // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–¥–∞–∂–∏ –±–µ–∑ —Ç–æ–≤–∞—Ä–æ–≤ (–≤—Å–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã)
        sales = sales.Where(s => s.Products.Any()).ToList();
    }

    private void ToggleExpand(int saleId)
    {
        if (expandedSaleId == saleId)
            expandedSaleId = null;
        else
            expandedSaleId = saleId;

        StateHasChanged();
    }

    private void ShowConfirmDeliveryModal(Sale sale)
    {
        selectedSale = sale;
        confirmError = "";
        showConfirmDeliveryModal = true;
        StateHasChanged();
    }

    private void CloseConfirmDeliveryModal()
    {
        showConfirmDeliveryModal = false;
        selectedSale = null;
        confirmError = "";
        StateHasChanged();
    }

    private async Task ConfirmDelivery()
    {
        if (selectedSale == null) return;

        confirmError = "";

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–¥–∞–∂–∏
            var sale = await context.Sales
                .Include(s => s.Products)
                .FirstOrDefaultAsync(s => s.Id == selectedSale.Id);

            if (sale == null)
            {
                confirmError = "–ü—Ä–æ–¥–∞–∂–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!";
                StateHasChanged();
                return;
            }

            sale.Status = "–ü–æ–ª—É—á–µ–Ω–æ";
            sale.UpdatedAt = DateTime.UtcNow;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ø—Ä–æ–¥–∞–∂–µ
            foreach (var product in sale.Products)
            {
                product.Status = "–ü—Ä–æ–¥–∞–Ω–æ";
                product.UpdatedAt = DateTime.UtcNow;
            }

            await context.SaveChangesAsync();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥–∞–∂
            await LoadSales();

            CloseConfirmDeliveryModal();
        }
        catch (Exception ex)
        {
            confirmError = $"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏: {ex.Message}";
            StateHasChanged();
        }
    }

    private void ShowReturnModal(Sale sale)
    {
        selectedSale = sale;
        returnSelectedProducts.Clear();
        returnError = "";
        showReturnModal = true;
        StateHasChanged();
    }

    private void CloseReturnModal()
    {
        showReturnModal = false;
        selectedSale = null;
        returnSelectedProducts.Clear();
        returnError = "";
        StateHasChanged();
    }

    private void ToggleReturnProduct(int productId)
    {
        if (returnSelectedProducts.Contains(productId))
            returnSelectedProducts.Remove(productId);
        else
            returnSelectedProducts.Add(productId);

        StateHasChanged();
    }

    private void SelectAllProducts()
    {
        if (selectedSale != null)
        {
            returnSelectedProducts = selectedSale.Products.Select(p => p.Id).ToHashSet();
            StateHasChanged();
        }
    }

    private void DeselectAllProducts()
    {
        returnSelectedProducts.Clear();
        StateHasChanged();
    }

    private async Task ProcessReturn()
    {
        if (selectedSale == null || !returnSelectedProducts.Any()) return;

        returnError = "";

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var sale = await context.Sales.FindAsync(selectedSale.Id);

            if (sale == null)
            {
                returnError = "–ü—Ä–æ–¥–∞–∂–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!";
                StateHasChanged();
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï —Ç–æ–≤–∞—Ä—ã —ç—Ç–æ–π –ø—Ä–æ–¥–∞–∂–∏
            var allProducts = await context.Products
                .Where(p => p.SaleId == sale.Id)
                .ToListAsync();

            // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ
            var productsToReturn = allProducts.Where(p => returnSelectedProducts.Contains(p.Id)).ToList();
            var productsNotReturned = allProducts.Where(p => !returnSelectedProducts.Contains(p.Id)).ToList();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç
            foreach (var product in productsToReturn)
            {
                product.Status = "–í–æ–∑–≤—Ä–∞—Ç";  // –¢–æ–≤–∞—Ä –µ—â–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω —Ñ–∏–∑–∏—á–µ—Å–∫–∏
                // –ù–ï –æ–±–Ω—É–ª—è–µ–º SaleId - —Ç–æ–≤–∞—Ä –≤—Å–µ –µ—â–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø—Ä–æ–¥–∞–∂–µ
                product.UpdatedAt = DateTime.UtcNow;
                context.Entry(product).State = EntityState.Modified;
            }

            // –¢–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è, –ø–æ–ª—É—á–∞—é—Ç —Å—Ç–∞—Ç—É—Å "–ü—Ä–æ–¥–∞–Ω–æ"
            foreach (var product in productsNotReturned)
            {
                product.Status = "–ü—Ä–æ–¥–∞–Ω–æ";
                product.UpdatedAt = DateTime.UtcNow;
                context.Entry(product).State = EntityState.Modified;
            }

            // –ï—Å–ª–∏ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã, –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–¥–∞–∂–∏
            var remainingProducts = productsNotReturned.Count;

            if (remainingProducts == 0)
            {
                // –ü–æ–ª–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
                sale.Status = "–í–æ–∑–≤—Ä–∞—Ç";
            }
            else
            {
                // –ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
                sale.Status = "–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç";
            }

            sale.UpdatedAt = DateTime.UtcNow;
            context.Entry(sale).State = EntityState.Modified;

            await context.SaveChangesAsync();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥–∞–∂
            await LoadSales();

            CloseReturnModal();
        }
        catch (Exception ex)
        {
            returnError = $"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task MarkAsShipped(Sale sale)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var saleToUpdate = await context.Sales.FindAsync(sale.Id);
            if (saleToUpdate == null)
            {
                return;
            }

            saleToUpdate.Status = "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ";
            saleToUpdate.UpdatedAt = DateTime.UtcNow;
            context.Entry(saleToUpdate).State = EntityState.Modified;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ø—Ä–æ–¥–∞–∂–µ
            var products = await context.Products
                .Where(p => p.SaleId == sale.Id)
                .ToListAsync();

            foreach (var product in products)
            {
                product.Status = "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ";
                product.UpdatedAt = DateTime.UtcNow;
                context.Entry(product).State = EntityState.Modified;
            }

            await context.SaveChangesAsync();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥–∞–∂
            await LoadSales();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: {ex.Message}");
        }
    }

    private string GetProductStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "–æ–∂–∏–¥–∞–µ—Ç" => "status-–æ–∂–∏–¥–∞–µ—Ç",
            "–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" => "status-–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ",
            "–≤–æ–∑–≤—Ä–∞—Ç" => "status-–≤–æ–∑–≤—Ä–∞—Ç",
            "–ø—Ä–æ–¥–∞–Ω–æ" => "status-–ø—Ä–æ–¥–∞–Ω–æ",
            _ => ""
        };
    }

    private async Task MarkReturnAsReceived(Product product)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var productToUpdate = await context.Products.FindAsync(product.Id);
            if (productToUpdate == null)
            {
                return;
            }

            var originalSaleId = productToUpdate.OriginalSaleId;

            // –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "–í –Ω–∞–ª–∏—á–∏–∏" - —Ç–æ–≤–∞—Ä —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –≤–µ—Ä–Ω—É–ª—Å—è –Ω–∞ —Å–∫–ª–∞–¥
            productToUpdate.Status = "–í –Ω–∞–ª–∏—á–∏–∏";
            productToUpdate.SaleId = null;  // –û—Ç–≤—è–∑—ã–≤–∞–µ–º –æ—Ç —Ç–µ–∫—É—â–µ–π –ø—Ä–æ–¥–∞–∂–∏
            productToUpdate.Buyer = null;
            productToUpdate.SalePrice = 0;
            productToUpdate.SaleDate = null;
            productToUpdate.UpdatedAt = DateTime.UtcNow;
            context.Entry(productToUpdate).State = EntityState.Modified;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ —Ç–æ–≤–∞—Ä—ã –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–µ –¥–ª—è —ç—Ç–æ–π –ø—Ä–æ–¥–∞–∂–∏
            if (originalSaleId.HasValue)
            {
                var remainingReturns = await context.Products
                    .Where(p => p.OriginalSaleId == originalSaleId.Value && p.Status == "–í–æ–∑–≤—Ä–∞—Ç")
                    .CountAsync();

                // –ï—Å–ª–∏ –±–æ–ª—å—à–µ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–µ, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–¥–∞–∂–∏
                if (remainingReturns == 0)
                {
                    var sale = await context.Sales.FindAsync(originalSaleId.Value);
                    if (sale != null)
                    {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –≤–æ–æ–±—â–µ —Ç–æ–≤–∞—Ä—ã —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø—Ä–æ–¥–∞–∂–µ–π (–∫—Ä–æ–º–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—ã—Ö)
                        var remainingProducts = await context.Products
                            .Where(p => p.OriginalSaleId == originalSaleId.Value && p.SaleId != null)
                            .CountAsync();

                        if (remainingProducts == 0)
                        {
                            // –í—Å–µ —Ç–æ–≤–∞—Ä—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –∏ –ø–æ–ª—É—á–µ–Ω—ã - –ø—Ä–æ–¥–∞–∂–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                            sale.Status = "–ü–æ–ª—É—á–µ–Ω–æ";
                        }
                        sale.UpdatedAt = DateTime.UtcNow;
                        context.Entry(sale).State = EntityState.Modified;
                    }
                }
            }

            await context.SaveChangesAsync();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥–∞–∂
            await LoadSales();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: {ex.Message}");
        }
    }
}
