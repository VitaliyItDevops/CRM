@page "/"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using bryx_CRM.Data
@using bryx_CRM.Data.Models
@using System.Text.Json
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer
@attribute [Authorize]

<PageTitle>–ì–ª–∞–≤–Ω–∞—è - bryx CRM</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4">üìä –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
            <p class="text-muted">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–æ–º bryx CRM</p>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–∏–æ–¥—É -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">üìÖ –ü–µ—Ä–∏–æ–¥ –æ—Ç—á–µ—Ç–∞</h5>
                    <div class="row g-3">
                        <!-- –ü–µ—Ä–∏–æ–¥ -->
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">–î–∞—Ç–∞ –æ—Ç / –¥–æ</label>
                            <div class="row g-2">
                                <div class="col">
                                    <input type="date" class="form-control form-control-sm" @bind="dateFrom" @bind:after="OnPeriodChanged" />
                                    <small class="text-muted">–û—Ç</small>
                                </div>
                                <div class="col">
                                    <input type="date" class="form-control form-control-sm" @bind="dateTo" @bind:after="OnPeriodChanged" />
                                    <small class="text-muted">–î–æ</small>
                                </div>
                            </div>
                        </div>

                        <!-- –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">‚ö° –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä</label>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => SetPeriodAndReload(7)">7 –¥–Ω–µ–π</button>
                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => SetPeriodAndReload(30)">–ú–µ—Å—è—Ü</button>
                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => SetPeriodAndReload(90)">3 –º–µ—Å—è—Ü–∞</button>
                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => SetPeriodAndReload(365)">–ì–æ–¥</button>
                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="SetAllTimeAndReload">–í—Å—ë –≤—Ä–µ–º—è</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="mt-3">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
        </div>
    }
    else
    {
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
        <div class="row g-4 mb-4">
            <!-- –í –Ω–∞–ª–∏—á–∏–∏ -->
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem;">–í –Ω–∞–ª–∏—á–∏–∏</h6>
                                <h2 class="mb-0 fw-bold">@inStockCount</h2>
                                <small class="text-success">
                                    <span class="badge bg-success-subtle text-success mt-2">
                                        –ù–∞ —Å—É–º–º—É: @inStockValue.ToString("N0") ‚ÇΩ
                                    </span>
                                </small>
                            </div>
                            <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                <svg width="32" height="32" fill="currentColor" class="text-success">
                                    <use href="#box-icon"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –û–∂–∏–¥–∞–µ—Ç—Å—è -->
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem;">–û–∂–∏–¥–∞–µ—Ç—Å—è</h6>
                                <h2 class="mb-0 fw-bold">@expectedCount</h2>
                                <small class="text-warning">
                                    <span class="badge bg-warning-subtle text-warning mt-2">
                                        –ù–∞ —Å—É–º–º—É: @expectedValue.ToString("N0") ‚ÇΩ
                                    </span>
                                </small>
                            </div>
                            <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                                <svg width="32" height="32" fill="currentColor" class="text-warning">
                                    <use href="#clock-icon"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ -->
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem;">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</h6>
                                <h2 class="mb-0 fw-bold">@shippedCount</h2>
                                <small class="text-info">
                                    <span class="badge bg-info-subtle text-info mt-2">
                                        –ù–∞ —Å—É–º–º—É: @shippedValue.ToString("N0") ‚ÇΩ
                                    </span>
                                </small>
                            </div>
                            <div class="bg-info bg-opacity-10 rounded-circle p-3">
                                <svg width="32" height="32" fill="currentColor" class="text-info">
                                    <use href="#truck-icon"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–æ–¥–∞–Ω–æ -->
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem;">–ü—Ä–æ–¥–∞–Ω–æ</h6>
                                <h2 class="mb-0 fw-bold">@soldCount</h2>
                                <small class="text-primary">
                                    <span class="badge bg-primary-subtle text-primary mt-2">
                                        –ù–∞ —Å—É–º–º—É: @soldValue.ToString("N0") ‚ÇΩ
                                    </span>
                                </small>
                            </div>
                            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                <svg width="32" height="32" fill="currentColor" class="text-primary">
                                    <use href="#cart-icon"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ -->
        <div class="row g-4 mb-4">
            <div class="col-lg-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-3">üí∞ –í—ã—Ä—É—á–∫–∞</h5>
                        <h3 class="mb-0 text-success fw-bold">@totalRevenue.ToString("N2") ‚ÇΩ</h3>
                        <p class="text-muted small mt-2 mb-0">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ –æ—Ç –ø—Ä–æ–¥–∞–∂</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-3">üí∏ –†–∞—Å—Ö–æ–¥—ã</h5>
                        <h3 class="mb-0 text-danger fw-bold">@totalExpenses.ToString("N2") ‚ÇΩ</h3>
                        <p class="text-muted small mt-2 mb-0">–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-3">üìà –ü—Ä–∏–±—ã–ª—å</h5>
                        <h3 class="mb-0 text-primary fw-bold">@totalProfit.ToString("N2") ‚ÇΩ</h3>
                        <p class="text-muted small mt-2 mb-0">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-3">üíπ –ú–∞—Ä–∂–∞</h5>
                        <h3 class="mb-0 fw-bold" style="color: #6610f2;">@averageMargin.ToString("N1")%</h3>
                        <p class="text-muted small mt-2 mb-0">–°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-3">üíº –°–∞–ª—å–¥–æ</h5>
                        <h3 class="mb-0 fw-bold" style="color: #d63384;">@totalBalance.ToString("N2") ‚ÇΩ</h3>
                        <p class="text-muted small mt-2 mb-0">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∞–∫—Ç–∏–≤–æ–≤</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–æ–¥–∞–∂–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <div class="row g-4 mb-4">
            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏ -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 pt-3 pb-0">
                        <h5 class="card-title mb-3">üõí –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏</h5>
                    </div>
                    <div class="card-body">
                        @if (recentSales.Any())
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var sale in recentSales)
                                {
                                    <div class="list-group-item border-0 px-0">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">@sale.Buyer</h6>
                                                <small class="text-muted">
                                                    @sale.SaleDate?.ToString("dd.MM.yyyy HH:mm") |
                                                    @sale.ProductCount —Ç–æ–≤–∞—Ä(–æ–≤)
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <div class="fw-bold text-success">@sale.TotalAmount.ToString("N0") ‚ÇΩ</div>
                                                <span class="badge @GetStatusBadgeClass(sale.Status) mt-1">
                                                    @GetStatusText(sale.Status)
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted text-center py-4 mb-0">–ù–µ—Ç –ø—Ä–æ–¥–∞–∂</p>
                        }
                    </div>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 pt-3 pb-0">
                        <h5 class="card-title mb-3">üì¶ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤</h5>
                    </div>
                    <div class="card-body">
                        @if (categoryStats.Any())
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var cat in categoryStats)
                                {
                                    <div class="list-group-item border-0 px-0">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">@cat.CategoryName</h6>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar" role="progressbar"
                                                         style="width: @cat.Percentage%;"
                                                         aria-valuenow="@cat.Percentage"
                                                         aria-valuemin="0"
                                                         aria-valuemax="100">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="text-end ms-3">
                                                <div class="fw-bold">@cat.Count</div>
                                                <small class="text-muted">@cat.Percentage.ToString("N1")%</small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted text-center py-4 mb-0">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- –ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã -->
        @if (favoriteProducts.Any())
        {
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 pt-3 pb-0">
                            <h5 class="card-title mb-3">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                            <th>–¶–≤–µ—Ç</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <th class="text-end">–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏</th>
                                            <th class="text-end">–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var product in favoriteProducts)
                                        {
                                            <tr>
                                                <td>@product.Category</td>
                                                <td>@product.Name</td>
                                                <td>
                                                    @if (!string.IsNullOrWhiteSpace(product.Color))
                                                    {
                                                        <span class="badge bg-secondary">@product.Color</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">‚Äî</span>
                                                    }
                                                </td>
                                                <td>
                                                    <span class="badge @GetProductStatusBadgeClass(product.Status)">
                                                        @product.Status
                                                    </span>
                                                </td>
                                                <td class="text-end">@product.PurchasePrice.ToString("N2") ‚ÇΩ</td>
                                                <td class="text-end">@product.SalePrice.ToString("N2") ‚ÇΩ</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –≥—Ä–∞—Ñ–∏–∫–∏</h2>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 pt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">üì¶ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h5>
                            <button class="btn btn-sm btn-primary" @onclick="UpdateCharts">
                                <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
                            </button>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-md-6">
                                <select class="form-select form-select-sm" @bind="selectedCategory" @bind:after="OnCategoryChanged">
                                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                                    @foreach (var cat in availableCategories)
                                    {
                                        <option value="@cat">@cat</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ –º–æ–¥–µ–ª—è–º -->
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 pt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">üè∑Ô∏è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –º–æ–¥–µ–ª—è–º</h5>
                            <button class="btn btn-sm btn-primary" @onclick="UpdateCharts">
                                <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
                            </button>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-md-6">
                                <select class="form-select form-select-sm" @bind="selectedModel" @bind:after="OnModelChanged">
                                    <option value="">–í—Å–µ –º–æ–¥–µ–ª–∏</option>
                                    @foreach (var model in availableModels)
                                    {
                                        <option value="@model">@model</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="modelChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Ü–≤–µ—Ç–∞–º -->
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 pt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">üé® –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ü–≤–µ—Ç–∞–º</h5>
                            <button class="btn btn-sm btn-primary" @onclick="UpdateCharts">
                                <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
                            </button>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-md-6">
                                <select class="form-select form-select-sm" @bind="selectedColor">
                                    <option value="">–í—Å–µ —Ü–≤–µ—Ç–∞</option>
                                    @foreach (var color in availableColors)
                                    {
                                        <option value="@color">@color</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="colorChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    /* Apple Dark Theme Colors */
    :root {
        --apple-dark-bg: #1c1c1e;
        --apple-dark-secondary: #2c2c2e;
        --apple-dark-tertiary: #3a3a3c;
        --apple-text-primary: #f5f5f7;
        --apple-text-secondary: #98989d;
        --apple-text-tertiary: #636366;
        --apple-border: rgba(255, 255, 255, 0.1);
        --apple-separator: rgba(84, 84, 88, 0.65);
    }

    /* Dark Cards */
    .card {
        background-color: var(--apple-dark-bg) !important;
        border: 1px solid var(--apple-border) !important;
        color: var(--apple-text-primary) !important;
    }

    .card-header {
        background-color: var(--apple-dark-bg) !important;
        border-bottom: 1px solid var(--apple-border) !important;
        color: var(--apple-text-primary) !important;
    }

    .card-body {
        background-color: var(--apple-dark-bg) !important;
        color: var(--apple-text-primary) !important;
    }

    .card-title {
        color: var(--apple-text-primary) !important;
    }

    /* Text Colors */
    h1, h2, h3, h4, h5, h6 {
        color: var(--apple-text-primary) !important;
    }

    .text-muted {
        color: var(--apple-text-secondary) !important;
    }

    small {
        color: var(--apple-text-secondary) !important;
    }

    /* Tables */
    .table {
        color: var(--apple-text-primary) !important;
    }

    .table-light {
        background-color: var(--apple-dark-secondary) !important;
        color: var(--apple-text-primary) !important;
    }

    .table-light th {
        background-color: var(--apple-dark-secondary) !important;
        color: var(--apple-text-secondary) !important;
        border-color: var(--apple-border) !important;
    }

    .table > :not(caption) > * > * {
        border-bottom-color: var(--apple-border) !important;
    }

    .table-hover tbody tr:hover {
        background-color: var(--apple-dark-secondary) !important;
        color: var(--apple-text-primary) !important;
    }

    /* List Groups */
    .list-group-item {
        background-color: var(--apple-dark-bg) !important;
        color: var(--apple-text-primary) !important;
        border-color: var(--apple-border) !important;
    }

    .list-group-item:hover {
        background-color: var(--apple-dark-secondary) !important;
    }

    /* Forms */
    .form-control, .form-select {
        background-color: var(--apple-dark-secondary) !important;
        border: 1px solid var(--apple-border) !important;
        color: var(--apple-text-primary) !important;
    }

    .form-control:focus, .form-select:focus {
        background-color: var(--apple-dark-tertiary) !important;
        border-color: #0a84ff !important;
        color: var(--apple-text-primary) !important;
        box-shadow: 0 0 0 0.25rem rgba(10, 132, 255, 0.25) !important;
    }

    .form-control::placeholder {
        color: var(--apple-text-tertiary) !important;
    }

    .form-label {
        color: var(--apple-text-secondary) !important;
    }

    /* Backgrounds */
    .bg-light {
        background-color: var(--apple-dark-secondary) !important;
        color: var(--apple-text-primary) !important;
    }

    /* Progress Bars */
    .progress {
        background-color: var(--apple-dark-secondary) !important;
    }

    /* Metric Cards with Icons */
    .bg-success.bg-opacity-10 {
        background-color: rgba(48, 209, 88, 0.15) !important;
    }

    .bg-warning.bg-opacity-10 {
        background-color: rgba(255, 214, 10, 0.15) !important;
    }

    .bg-info.bg-opacity-10 {
        background-color: rgba(100, 210, 255, 0.15) !important;
    }

    .bg-primary.bg-opacity-10 {
        background-color: rgba(10, 132, 255, 0.15) !important;
    }

    /* Badge Styling */
    .badge {
        font-weight: 500 !important;
    }

    .bg-success-subtle {
        background-color: rgba(48, 209, 88, 0.2) !important;
        color: #32d74b !important;
    }

    .bg-warning-subtle {
        background-color: rgba(255, 214, 10, 0.2) !important;
        color: #ffd60a !important;
    }

    .bg-info-subtle {
        background-color: rgba(100, 210, 255, 0.2) !important;
        color: #64d2ff !important;
    }

    .bg-primary-subtle {
        background-color: rgba(10, 132, 255, 0.2) !important;
        color: #0a84ff !important;
    }

    .text-success {
        color: #32d74b !important;
    }

    .text-warning {
        color: #ffd60a !important;
    }

    .text-info {
        color: #64d2ff !important;
    }

    .text-primary {
        color: #0a84ff !important;
    }

    /* Chart Container */
    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
    }

    /* Alerts */
    .alert-danger {
        background-color: rgba(255, 69, 58, 0.15) !important;
        border-color: rgba(255, 69, 58, 0.3) !important;
        color: #ff453a !important;
    }

    .alert-success {
        background-color: rgba(48, 209, 88, 0.15) !important;
        border-color: rgba(48, 209, 88, 0.3) !important;
        color: #32d74b !important;
    }

    .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    /* –ú–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ */
    @@media (max-width: 767px) {
        .chart-container {
            height: 400px;
        }

        .card-header h5 {
            font-size: 0.95rem;
        }

        .btn-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
    }

    /* –ü–ª–∞–Ω—à–µ—Ç—ã */
    @@media (min-width: 768px) and (max-width: 1023px) {
        .chart-container {
            height: 380px;
        }
    }
</style>

<!-- SVG Icons -->
<svg style="display: none;">
    <symbol id="box-icon" viewBox="0 0 16 16">
        <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5 8 5.961 14.154 3.5 8.186 1.113zM15 4.239l-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
    </symbol>
    <symbol id="clock-icon" viewBox="0 0 16 16">
        <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
    </symbol>
    <symbol id="truck-icon" viewBox="0 0 16 16">
        <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5v-7zm1.294 7.456A1.999 1.999 0 0 1 4.732 11h5.536a2.01 2.01 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456zM12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12v4zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
    </symbol>
    <symbol id="cart-icon" viewBox="0 0 16 16">
        <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM3.102 4l1.313 7h8.17l1.313-7H3.102zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
    </symbol>
</svg>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º window –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    window.chartInstances = window.chartInstances || {};

    window.renderMultiMetricChart = function(canvasId, chartData) {
        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (window.chartInstances[canvasId]) {
            window.chartInstances[canvasId].destroy();
        }

        const ctx = document.getElementById(canvasId);
        if (!ctx) {
            console.error('Canvas not found:', canvasId);
            return;
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–±–∏–ª—å–Ω–æ–µ –ª–∏ —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
        const isMobile = window.innerWidth < 768;

        // Apple Dark Theme colors
        const textColor = '#f5f5f7';
        const gridColor = 'rgba(255, 255, 255, 0.1)';
        const tooltipBg = 'rgba(44, 44, 46, 0.95)';

        // –°–æ–∑–¥–∞–µ–º —Å—Ç–æ–ª–±—á–∞—Ç—ã–π –≥—Ä–∞—Ñ–∏–∫ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏
        window.chartInstances[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: isMobile ? 'bottom' : 'top',
                        labels: {
                            color: textColor,
                            boxWidth: isMobile ? 8 : 12,
                            padding: isMobile ? 5 : 10,
                            font: {
                                size: isMobile ? 8 : 10,
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
                            }
                        }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: tooltipBg,
                        titleColor: textColor,
                        bodyColor: textColor,
                        borderColor: gridColor,
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                let value = context.parsed.y;

                                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –º–µ—Ç—Ä–∏–∫–∏
                                if (label.includes('‚ÇΩ')) {
                                    return label + ': ' + new Intl.NumberFormat('ru-RU').format(value) + ' ‚ÇΩ';
                                } else if (label.includes('%')) {
                                    return label + ': ' + value.toFixed(1) + '%';
                                } else if (label.includes('—à—Ç')) {
                                    return label + ': ' + value + ' —à—Ç';
                                } else {
                                    return label + ': ' + value;
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false,
                            color: gridColor
                        },
                        ticks: {
                            color: textColor,
                            font: {
                                size: isMobile ? 9 : 11,
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
                            },
                            maxRotation: isMobile ? 45 : 0,
                            minRotation: isMobile ? 45 : 0
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: gridColor,
                            drawBorder: false
                        },
                        ticks: {
                            color: textColor,
                            font: {
                                size: isMobile ? 9 : 10,
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
                            },
                            callback: function(value) {
                                return new Intl.NumberFormat('ru-RU', {
                                    notation: 'compact',
                                    compactDisplay: 'short'
                                }).format(value);
                            }
                        }
                    }
                }
            }
        });
    };
</script>

@code {
    private bool isLoading = true;

    // –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    private int inStockCount = 0;
    private decimal inStockValue = 0;
    private int expectedCount = 0;
    private decimal expectedValue = 0;
    private int shippedCount = 0;
    private decimal shippedValue = 0;
    private int soldCount = 0;
    private decimal soldValue = 0;

    // –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    private decimal totalRevenue = 0;
    private decimal totalExpenses = 0;
    private decimal totalProfit = 0;
    private decimal averageMargin = 0;
    private decimal totalBalance = 0;

    // –ö–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
    private List<SaleInfo> recentSales = new();
    private List<CategoryStat> categoryStats = new();
    private List<Product> favoriteProducts = new();

    // –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    private DateTime dateFrom = DateTime.UtcNow.AddMonths(-1);
    private DateTime dateTo = DateTime.UtcNow;
    private string selectedCategory = "";
    private string selectedModel = "";
    private string selectedColor = "";
    private bool chartRendered = false;

    // –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    private List<string> availableCategories = new();
    private List<string> availableModels = new();
    private List<string> availableColors = new();

    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    private List<AnalyticsData> categoryData = new();
    private List<AnalyticsData> modelData = new();
    private List<AnalyticsData> colorData = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadStatistics();
        await LoadFilterOptions();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!isLoading && !chartRendered)
        {
            chartRendered = true;
            await Task.Delay(500);
            await UpdateCharts();
        }
    }

    private async Task LoadFilterOptions()
    {
        using var context = await DbContextFactory.CreateDbContextAsync();

        availableCategories = await context.Products
            .Select(p => p.Category)
            .Distinct()
            .OrderBy(c => c)
            .ToListAsync();

        availableModels = await context.Products
            .Select(p => p.Name)
            .Distinct()
            .OrderBy(n => n)
            .ToListAsync();

        availableColors = await context.Products
            .Where(p => !string.IsNullOrWhiteSpace(p.Color))
            .Select(p => p.Color!)
            .Distinct()
            .OrderBy(c => c)
            .ToListAsync();
    }

    private void SetPeriod(int days)
    {
        dateTo = DateTime.UtcNow;
        dateFrom = dateTo.AddDays(-days);
    }

    private async Task SetAllTime()
    {
        using var context = await DbContextFactory.CreateDbContextAsync();
        var minDate = await context.Products
            .Where(p => p.CreatedAt != DateTime.MinValue)
            .OrderBy(p => p.CreatedAt)
            .Select(p => p.CreatedAt)
            .FirstOrDefaultAsync();

        dateFrom = minDate != default ? minDate : DateTime.UtcNow.AddYears(-5);
        dateTo = DateTime.UtcNow;
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–µ—Ä–∏–æ–¥–∞
    private async Task OnPeriodChanged()
    {
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –≤ UTC –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å PostgreSQL
        dateFrom = DateTime.SpecifyKind(dateFrom, DateTimeKind.Utc);
        dateTo = DateTime.SpecifyKind(dateTo, DateTimeKind.Utc);

        await LoadStatistics();
        await UpdateCharts();
    }

    private async Task SetPeriodAndReload(int days)
    {
        dateTo = DateTime.UtcNow;
        dateFrom = dateTo.AddDays(-days);
        await OnPeriodChanged();
    }

    private async Task SetAllTimeAndReload()
    {
        await SetAllTime();
        await OnPeriodChanged();
    }

    private async Task OnCategoryChanged()
    {
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        using var context = await DbContextFactory.CreateDbContextAsync();

        if (string.IsNullOrEmpty(selectedCategory))
        {
            // –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–µ–ª–∏
            availableModels = await context.Products
                .Select(p => p.Name)
                .Distinct()
                .OrderBy(n => n)
                .ToListAsync();
        }
        else
        {
            // –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –≤—ã–±—Ä–∞–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –º–æ–¥–µ–ª–∏ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            availableModels = await context.Products
                .Where(p => p.Category == selectedCategory)
                .Select(p => p.Name)
                .Distinct()
                .OrderBy(n => n)
                .ToListAsync();
        }

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å, –µ—Å–ª–∏ –µ—ë –±–æ–ª—å—à–µ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ
        if (!string.IsNullOrEmpty(selectedModel) && !availableModels.Contains(selectedModel))
        {
            selectedModel = "";
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
        await UpdateCharts();
    }

    private async Task OnModelChanged()
    {
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        using var context = await DbContextFactory.CreateDbContextAsync();

        if (string.IsNullOrEmpty(selectedModel))
        {
            // –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ü–≤–µ—Ç–∞
            availableColors = await context.Products
                .Where(p => !string.IsNullOrWhiteSpace(p.Color))
                .Select(p => p.Color!)
                .Distinct()
                .OrderBy(c => c)
                .ToListAsync();
        }
        else
        {
            // –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –≤—ã–±—Ä–∞–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–≤–µ—Ç–∞ —ç—Ç–æ–π –º–æ–¥–µ–ª–∏
            availableColors = await context.Products
                .Where(p => p.Name == selectedModel && !string.IsNullOrWhiteSpace(p.Color))
                .Select(p => p.Color!)
                .Distinct()
                .OrderBy(c => c)
                .ToListAsync();
        }

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç, –µ—Å–ª–∏ –µ–≥–æ –±–æ–ª—å—à–µ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ
        if (!string.IsNullOrEmpty(selectedColor) && !availableColors.Contains(selectedColor))
        {
            selectedColor = "";
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
        await UpdateCharts();
    }

    private async Task UpdateCharts()
    {
        StateHasChanged();

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var allProducts = await context.Products.ToListAsync();

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ PrepareChartData
            await RenderSimpleCharts();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating charts: {ex.Message}");
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task RenderSimpleCharts()
    {
        try
        {
            // –ì—Ä–∞—Ñ–∏–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º - —Ñ–∏–ª—å—Ç—Ä—É–µ–º –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è
            var filteredCategoryData = string.IsNullOrEmpty(selectedCategory)
                ? categoryData
                : categoryData.Where(d => d.Label == selectedCategory).ToList();

            if (filteredCategoryData.Any())
            {
                var catData = new
                {
                    labels = filteredCategoryData.Select(d => d.Label).ToArray(),
                    datasets = new object[]
                    {
                        new { label = "–ü—Ä–æ–¥–∞–Ω–æ (—à—Ç)", data = filteredCategoryData.Select(d => (double)d.Units).ToArray(), backgroundColor = "#0d6efd" },
                        new { label = "–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)", data = filteredCategoryData.Select(d => (double)d.Revenue).ToArray(), backgroundColor = "#198754" },
                        new { label = "–ó–∞—Ç—Ä–∞—Ç—ã (‚ÇΩ)", data = filteredCategoryData.Select(d => (double)d.Costs).ToArray(), backgroundColor = "#fd7e14" },
                        new { label = "–ü—Ä–∏–±—ã–ª—å (‚ÇΩ)", data = filteredCategoryData.Select(d => (double)d.Profit).ToArray(), backgroundColor = "#6610f2" },
                        new { label = "–ú–∞—Ä–∂–∞ (%)", data = filteredCategoryData.Select(d => (double)d.Margin).ToArray(), backgroundColor = "#ffc107" },
                        new { label = "–°–∞–ª—å–¥–æ (‚ÇΩ)", data = filteredCategoryData.Select(d => (double)d.Balance).ToArray(), backgroundColor = "#d63384" },
                        new { label = "–í–æ–∑–≤—Ä–∞—Ç—ã (—à—Ç)", data = filteredCategoryData.Select(d => (double)d.Returns).ToArray(), backgroundColor = "#6c757d" },
                        new { label = "–ë—Ä–∞–∫ (—à—Ç)", data = filteredCategoryData.Select(d => (double)d.Defective).ToArray(), backgroundColor = "#dc3545" }
                    }
                };
                await JSRuntime.InvokeVoidAsync("renderMultiMetricChart", "categoryChart", catData);
            }

            // –ì—Ä–∞—Ñ–∏–∫ –ø–æ –º–æ–¥–µ–ª—è–º - —Ñ–∏–ª—å—Ç—Ä—É–µ–º –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å
            var filteredModelData = string.IsNullOrEmpty(selectedModel)
                ? modelData
                : modelData.Where(d => d.Label == selectedModel).ToList();

            if (filteredModelData.Any())
            {
                var modData = new
                {
                    labels = filteredModelData.Select(d => d.Label).ToArray(),
                    datasets = new object[]
                    {
                        new { label = "–ü—Ä–æ–¥–∞–Ω–æ (—à—Ç)", data = filteredModelData.Select(d => (double)d.Units).ToArray(), backgroundColor = "#0d6efd" },
                        new { label = "–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)", data = filteredModelData.Select(d => (double)d.Revenue).ToArray(), backgroundColor = "#198754" },
                        new { label = "–ó–∞—Ç—Ä–∞—Ç—ã (‚ÇΩ)", data = filteredModelData.Select(d => (double)d.Costs).ToArray(), backgroundColor = "#fd7e14" },
                        new { label = "–ü—Ä–∏–±—ã–ª—å (‚ÇΩ)", data = filteredModelData.Select(d => (double)d.Profit).ToArray(), backgroundColor = "#6610f2" },
                        new { label = "–ú–∞—Ä–∂–∞ (%)", data = filteredModelData.Select(d => (double)d.Margin).ToArray(), backgroundColor = "#ffc107" },
                        new { label = "–°–∞–ª—å–¥–æ (‚ÇΩ)", data = filteredModelData.Select(d => (double)d.Balance).ToArray(), backgroundColor = "#d63384" },
                        new { label = "–í–æ–∑–≤—Ä–∞—Ç—ã (—à—Ç)", data = filteredModelData.Select(d => (double)d.Returns).ToArray(), backgroundColor = "#6c757d" },
                        new { label = "–ë—Ä–∞–∫ (—à—Ç)", data = filteredModelData.Select(d => (double)d.Defective).ToArray(), backgroundColor = "#dc3545" }
                    }
                };
                await JSRuntime.InvokeVoidAsync("renderMultiMetricChart", "modelChart", modData);
            }

            // –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Ü–≤–µ—Ç–∞–º - —Ñ–∏–ª—å—Ç—Ä—É–µ–º –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ü–≤–µ—Ç
            var filteredColorData = string.IsNullOrEmpty(selectedColor)
                ? colorData
                : colorData.Where(d => d.Label == selectedColor).ToList();

            if (filteredColorData.Any())
            {
                var colData = new
                {
                    labels = filteredColorData.Select(d => d.Label).ToArray(),
                    datasets = new object[]
                    {
                        new { label = "–ü—Ä–æ–¥–∞–Ω–æ (—à—Ç)", data = filteredColorData.Select(d => (double)d.Units).ToArray(), backgroundColor = "#0d6efd" },
                        new { label = "–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)", data = filteredColorData.Select(d => (double)d.Revenue).ToArray(), backgroundColor = "#198754" },
                        new { label = "–ó–∞—Ç—Ä–∞—Ç—ã (‚ÇΩ)", data = filteredColorData.Select(d => (double)d.Costs).ToArray(), backgroundColor = "#fd7e14" },
                        new { label = "–ü—Ä–∏–±—ã–ª—å (‚ÇΩ)", data = filteredColorData.Select(d => (double)d.Profit).ToArray(), backgroundColor = "#6610f2" },
                        new { label = "–ú–∞—Ä–∂–∞ (%)", data = filteredColorData.Select(d => (double)d.Margin).ToArray(), backgroundColor = "#ffc107" },
                        new { label = "–°–∞–ª—å–¥–æ (‚ÇΩ)", data = filteredColorData.Select(d => (double)d.Balance).ToArray(), backgroundColor = "#d63384" },
                        new { label = "–í–æ–∑–≤—Ä–∞—Ç—ã (—à—Ç)", data = filteredColorData.Select(d => (double)d.Returns).ToArray(), backgroundColor = "#6c757d" },
                        new { label = "–ë—Ä–∞–∫ (—à—Ç)", data = filteredColorData.Select(d => (double)d.Defective).ToArray(), backgroundColor = "#dc3545" }
                    }
                };
                await JSRuntime.InvokeVoidAsync("renderMultiMetricChart", "colorChart", colData);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering charts: {ex.Message}");
        }
    }

    private async Task LoadStatistics()
    {
        isLoading = true;

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–∞–º
            var allProducts = await context.Products.ToListAsync();

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –ø–µ—Ä–∏–æ–¥—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
            inStockCount = allProducts.Count(p => p.Status == "–í –Ω–∞–ª–∏—á–∏–∏" &&
                (p.ArrivalDate.HasValue ? p.ArrivalDate.Value >= dateFrom && p.ArrivalDate.Value <= dateTo
                                        : p.CreatedAt >= dateFrom && p.CreatedAt <= dateTo));
            inStockValue = allProducts.Where(p => p.Status == "–í –Ω–∞–ª–∏—á–∏–∏" &&
                (p.ArrivalDate.HasValue ? p.ArrivalDate.Value >= dateFrom && p.ArrivalDate.Value <= dateTo
                                        : p.CreatedAt >= dateFrom && p.CreatedAt <= dateTo))
                .Sum(p => p.PurchasePrice);

            expectedCount = allProducts.Count(p => p.Status == "–û–∂–∏–¥–∞–µ—Ç—Å—è" &&
                p.CreatedAt >= dateFrom && p.CreatedAt <= dateTo);
            expectedValue = allProducts.Where(p => p.Status == "–û–∂–∏–¥–∞–µ—Ç—Å—è" &&
                p.CreatedAt >= dateFrom && p.CreatedAt <= dateTo)
                .Sum(p => p.PurchasePrice);

            shippedCount = allProducts.Count(p => p.Status == "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" &&
                (p.DeliveryDate.HasValue ? p.DeliveryDate.Value >= dateFrom && p.DeliveryDate.Value <= dateTo
                                         : p.SaleDate.HasValue && p.SaleDate.Value >= dateFrom && p.SaleDate.Value <= dateTo));
            shippedValue = allProducts.Where(p => p.Status == "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" &&
                (p.DeliveryDate.HasValue ? p.DeliveryDate.Value >= dateFrom && p.DeliveryDate.Value <= dateTo
                                         : p.SaleDate.HasValue && p.SaleDate.Value >= dateFrom && p.SaleDate.Value <= dateTo))
                .Sum(p => p.SalePrice);

            soldCount = allProducts.Count(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ" &&
                p.SaleDate.HasValue && p.SaleDate.Value >= dateFrom && p.SaleDate.Value <= dateTo);
            soldValue = allProducts.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ" &&
                p.SaleDate.HasValue && p.SaleDate.Value >= dateFrom && p.SaleDate.Value <= dateTo)
                .Sum(p => p.SalePrice);

            // –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á–µ—Ç—ã - –ü–†–ê–í–ò–õ–¨–ù–´–ô –ú–ï–¢–û–î
            // 1. –í—ã—Ä—É—á–∫–∞ = —Å—É–º–º–∞ –≤—Å–µ—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Sales
            //    (–≤–∫–ª—é—á–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤ + —É—Å–ª—É–≥–∏)
            var completedSales = await context.Sales
                .Where(s => s.Status == "–ü–æ–ª—É—á–µ–Ω–æ" &&
                            s.SaleDate >= dateFrom &&
                            s.SaleDate <= dateTo)
                .ToListAsync();

            // –û–¢–õ–ê–î–ö–ê: –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥–∞–∂–∞—Ö
            Console.WriteLine($"üîç DEBUG: –ù–∞–π–¥–µ–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂: {completedSales.Count}");
            foreach (var sale in completedSales)
            {
                Console.WriteLine($"   - Sale ID: {sale.Id}, Buyer: {sale.Buyer}, Amount: {sale.TotalAmount:N2}, Date: {sale.SaleDate}");
            }

            totalRevenue = completedSales.Sum(s => s.TotalAmount);
            Console.WriteLine($"üí∞ DEBUG: –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: {totalRevenue:N2}");

            // 2. –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Ç–æ–≤–∞—Ä—ã = —Ü–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –†–ï–ê–õ–¨–ù–û –ø—Ä–æ–¥–∞–Ω—ã (—Å—Ç–∞—Ç—É—Å "–ü—Ä–æ–¥–∞–Ω–æ") –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ
            var soldProductsInSales = allProducts.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ" &&
                p.SaleDate.HasValue && p.SaleDate.Value >= dateFrom && p.SaleDate.Value <= dateTo).ToList();
            var productCosts = soldProductsInSales.Sum(p => p.PurchasePrice);
            Console.WriteLine($"üì¶ DEBUG: –¢–æ–≤–∞—Ä–æ–≤ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö: {soldProductsInSales.Count}, –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Ç–æ–≤–∞—Ä—ã: {productCosts:N2}");

            // 3. –†–∞—Å—Ö–æ–¥—ã = –≤—Å–µ —Ä–∞—Å—Ö–æ–¥—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Expenses –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ
            var allExpenses = await context.Expenses
                .Where(e => e.ExpenseDate >= dateFrom && e.ExpenseDate <= dateTo)
                .ToListAsync();
            totalExpenses = allExpenses.Sum(e => e.Amount);
            Console.WriteLine($"üí∏ DEBUG: –í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤: {allExpenses.Count}, –°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤: {totalExpenses:N2}");

            // 4. –ü—Ä–∏–±—ã–ª—å = –í—ã—Ä—É—á–∫–∞ - –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Ç–æ–≤–∞—Ä—ã - –†–∞—Å—Ö–æ–¥—ã
            //    (—É—Å–ª—É–≥–∏ –≤ –≤—ã—Ä—É—á–∫–µ —É–∂–µ —É—á—Ç–µ–Ω—ã, —É –Ω–∏—Ö –Ω–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏)
            totalProfit = totalRevenue - productCosts - totalExpenses;
            Console.WriteLine($"üíµ DEBUG: –ü—Ä–∏–±—ã–ª—å = {totalRevenue:N2} - {productCosts:N2} - {totalExpenses:N2} = {totalProfit:N2}");

            // 5. –ú–∞—Ä–∂–∞ = (–ü—Ä–∏–±—ã–ª—å / –í—ã—Ä—É—á–∫–∞) * 100
            if (totalRevenue > 0)
            {
                averageMargin = (totalProfit / totalRevenue) * 100;
            }
            else
            {
                averageMargin = 0;
            }
            Console.WriteLine($"üìä DEBUG: –ú–∞—Ä–∂–∞ = ({totalProfit:N2} / {totalRevenue:N2}) * 100 = {averageMargin:N2}%");

            // –°–∞–ª—å–¥–æ = –¢–µ–∫—É—â–∏–µ –∞–∫—Ç–∏–≤—ã (–≤ –Ω–∞–ª–∏—á–∏–∏ + –æ–∂–∏–¥–∞–µ—Ç—Å—è + –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ)
            totalBalance = inStockValue + expectedValue + shippedValue;

            // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø—Ä–æ–¥–∞–∂ —Å —É—á–µ—Ç–æ–º –ø–µ—Ä–∏–æ–¥–∞
            var sales = await context.Sales
                .Where(s => s.SaleDate >= dateFrom &&
                            s.SaleDate <= dateTo)
                .OrderByDescending(s => s.SaleDate)
                .Take(5)
                .ToListAsync();

            recentSales = new List<SaleInfo>();
            foreach (var sale in sales)
            {
                var products = await context.Products.Where(p => p.SaleId == sale.Id).ToListAsync();
                recentSales.Add(new SaleInfo
                {
                    Buyer = sale.Buyer ?? "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
                    SaleDate = sale.SaleDate,
                    TotalAmount = sale.TotalAmount,
                    ProductCount = products.Count,
                    Status = sale.Status ?? "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
                });
            }

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (—Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã –≤ –Ω–∞–ª–∏—á–∏–∏ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ)
            var inStockProducts = allProducts.Where(p => p.Status == "–í –Ω–∞–ª–∏—á–∏–∏" &&
                (p.ArrivalDate.HasValue ? p.ArrivalDate.Value >= dateFrom && p.ArrivalDate.Value <= dateTo
                                        : p.CreatedAt >= dateFrom && p.CreatedAt <= dateTo)).ToList();
            var totalInStock = inStockProducts.Count;

            if (totalInStock > 0)
            {
                categoryStats = inStockProducts
                    .GroupBy(p => p.Category)
                    .Select(g => new CategoryStat
                    {
                        CategoryName = g.Key,
                        Count = g.Count(),
                        Percentage = (g.Count() * 100.0 / totalInStock)
                    })
                    .OrderByDescending(c => c.Count)
                    .ToList();
            }

            // –ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ)
            favoriteProducts = allProducts
                .Where(p => p.IsFavorite)
                .OrderBy(p => p.Category)
                .ThenBy(p => p.Name)
                .Take(10)
                .ToList();

            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å —É—á–µ—Ç–æ–º –ø–µ—Ä–∏–æ–¥–∞
            await PrepareChartData(allProducts.Where(p =>
            {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
                DateTime? relevantDate = p.Status switch
                {
                    "–í –Ω–∞–ª–∏—á–∏–∏" => p.ArrivalDate ?? p.CreatedAt,
                    "–û–∂–∏–¥–∞–µ—Ç—Å—è" => p.CreatedAt,
                    "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" => p.DeliveryDate ?? p.SaleDate,
                    "–ü—Ä–æ–¥–∞–Ω–æ" => p.SaleDate,
                    _ => p.CreatedAt
                };

                return relevantDate.HasValue && relevantDate.Value >= dateFrom && relevantDate.Value <= dateTo;
            }).ToList());
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task PrepareChartData(List<Product> allProducts)
    {
        using var context = await DbContextFactory.CreateDbContextAsync();

        // –î–∞–Ω–Ω—ã–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        categoryData = allProducts
            .GroupBy(p => p.Category)
            .Select(g => new AnalyticsData
            {
                Label = g.Key,
                Balance = g.Sum(p => (p.Status == "–í –Ω–∞–ª–∏—á–∏–∏" || p.Status == "–û–∂–∏–¥–∞–µ—Ç—Å—è" || p.Status == "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ") ? p.PurchasePrice : 0),
                Revenue = g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice),
                Profit = g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice - p.PurchasePrice),
                Margin = g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice) > 0
                    ? (g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice - p.PurchasePrice) / g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice)) * 100
                    : 0,
                Costs = g.Sum(p => p.PurchasePrice),
                Units = g.Count(),
                Returns = g.Count(p => p.Status == "–í–æ–∑–≤—Ä–∞—Ç" || p.Status == "–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç"),
                Defective = g.Count(p => p.IsDefective)
            })
            .OrderByDescending(d => d.Revenue)
            .Take(10)
            .ToList();

        // –î–∞–Ω–Ω—ã–µ –ø–æ –º–æ–¥–µ–ª—è–º (–Ω–∞–∑–≤–∞–Ω–∏—è–º —Ç–æ–≤–∞—Ä–æ–≤) - —É—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        var productsForModels = string.IsNullOrEmpty(selectedCategory)
            ? allProducts
            : allProducts.Where(p => p.Category == selectedCategory).ToList();

        modelData = productsForModels
            .GroupBy(p => p.Name)
            .Select(g => new AnalyticsData
            {
                Label = g.Key,
                Balance = g.Sum(p => (p.Status == "–í –Ω–∞–ª–∏—á–∏–∏" || p.Status == "–û–∂–∏–¥–∞–µ—Ç—Å—è" || p.Status == "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ") ? p.PurchasePrice : 0),
                Revenue = g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice),
                Profit = g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice - p.PurchasePrice),
                Margin = g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice) > 0
                    ? (g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice - p.PurchasePrice) / g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice)) * 100
                    : 0,
                Costs = g.Sum(p => p.PurchasePrice),
                Units = g.Count(),
                Returns = g.Count(p => p.Status == "–í–æ–∑–≤—Ä–∞—Ç" || p.Status == "–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç"),
                Defective = g.Count(p => p.IsDefective)
            })
            .OrderByDescending(d => d.Revenue)
            .Take(10)
            .ToList();

        // –î–∞–Ω–Ω—ã–µ –ø–æ —Ü–≤–µ—Ç–∞–º
        colorData = allProducts
            .Where(p => !string.IsNullOrWhiteSpace(p.Color))
            .GroupBy(p => p.Color)
            .Select(g => new AnalyticsData
            {
                Label = g.Key ?? "–ë–µ–∑ —Ü–≤–µ—Ç–∞",
                Balance = g.Sum(p => (p.Status == "–í –Ω–∞–ª–∏—á–∏–∏" || p.Status == "–û–∂–∏–¥–∞–µ—Ç—Å—è" || p.Status == "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ") ? p.PurchasePrice : 0),
                Revenue = g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice),
                Profit = g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice - p.PurchasePrice),
                Margin = g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice) > 0
                    ? (g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice - p.PurchasePrice) / g.Where(p => p.Status == "–ü—Ä–æ–¥–∞–Ω–æ").Sum(p => p.SalePrice)) * 100
                    : 0,
                Costs = g.Sum(p => p.PurchasePrice),
                Units = g.Count(),
                Returns = g.Count(p => p.Status == "–í–æ–∑–≤—Ä–∞—Ç" || p.Status == "–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç"),
                Defective = g.Count(p => p.IsDefective)
            })
            .OrderByDescending(d => d.Revenue)
            .Take(10)
            .ToList();
    }

    private async Task RenderCharts()
    {
        try
        {
            Console.WriteLine($"RenderCharts called. Category data count: {categoryData.Count}, Model data count: {modelData.Count}, Color data count: {colorData.Count}");

            if (categoryData.Any())
            {
                Console.WriteLine("Rendering category chart...");
                await JSRuntime.InvokeVoidAsync("renderAnalyticsChart", "categoryChart",
                    JsonSerializer.Serialize(categoryData.Select(d => d.Label).ToList()),
                    JsonSerializer.Serialize(categoryData.Select(d => (double)d.Balance).ToList()),
                    JsonSerializer.Serialize(categoryData.Select(d => (double)d.Revenue).ToList()),
                    JsonSerializer.Serialize(categoryData.Select(d => (double)d.Profit).ToList()),
                    JsonSerializer.Serialize(categoryData.Select(d => (double)d.Margin).ToList()),
                    JsonSerializer.Serialize(categoryData.Select(d => (double)d.Costs).ToList()),
                    JsonSerializer.Serialize(categoryData.Select(d => d.Units).ToList()),
                    JsonSerializer.Serialize(categoryData.Select(d => d.Returns).ToList()),
                    JsonSerializer.Serialize(categoryData.Select(d => d.Defective).ToList())
                );
                Console.WriteLine("Category chart rendered successfully");
            }
            else
            {
                Console.WriteLine("No category data to display");
            }

            if (modelData.Any())
            {
                Console.WriteLine("Rendering model chart...");
                await JSRuntime.InvokeVoidAsync("renderAnalyticsChart", "modelChart",
                    JsonSerializer.Serialize(modelData.Select(d => d.Label).ToList()),
                    JsonSerializer.Serialize(modelData.Select(d => (double)d.Balance).ToList()),
                    JsonSerializer.Serialize(modelData.Select(d => (double)d.Revenue).ToList()),
                    JsonSerializer.Serialize(modelData.Select(d => (double)d.Profit).ToList()),
                    JsonSerializer.Serialize(modelData.Select(d => (double)d.Margin).ToList()),
                    JsonSerializer.Serialize(modelData.Select(d => (double)d.Costs).ToList()),
                    JsonSerializer.Serialize(modelData.Select(d => d.Units).ToList()),
                    JsonSerializer.Serialize(modelData.Select(d => d.Returns).ToList()),
                    JsonSerializer.Serialize(modelData.Select(d => d.Defective).ToList())
                );
                Console.WriteLine("Model chart rendered successfully");
            }
            else
            {
                Console.WriteLine("No model data to display");
            }

            if (colorData.Any())
            {
                Console.WriteLine("Rendering color chart...");
                await JSRuntime.InvokeVoidAsync("renderAnalyticsChart", "colorChart",
                    JsonSerializer.Serialize(colorData.Select(d => d.Label).ToList()),
                    JsonSerializer.Serialize(colorData.Select(d => (double)d.Balance).ToList()),
                    JsonSerializer.Serialize(colorData.Select(d => (double)d.Revenue).ToList()),
                    JsonSerializer.Serialize(colorData.Select(d => (double)d.Profit).ToList()),
                    JsonSerializer.Serialize(colorData.Select(d => (double)d.Margin).ToList()),
                    JsonSerializer.Serialize(colorData.Select(d => (double)d.Costs).ToList()),
                    JsonSerializer.Serialize(colorData.Select(d => d.Units).ToList()),
                    JsonSerializer.Serialize(colorData.Select(d => d.Returns).ToList()),
                    JsonSerializer.Serialize(colorData.Select(d => d.Defective).ToList())
                );
                Console.WriteLine("Color chart rendered successfully");
            }
            else
            {
                Console.WriteLine("No color data to display");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering charts: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "–ü–æ–ª—É—á–µ–Ω–æ" => "bg-success",
            "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" => "bg-info",
            "–í–æ–∑–≤—Ä–∞—Ç" => "bg-danger",
            "–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç" => "bg-warning",
            _ => "bg-secondary"
        };
    }

    private string GetStatusText(string status)
    {
        return status switch
        {
            "–ü–æ–ª—É—á–µ–Ω–æ" => "–ü–†–û–î–ê–ù–û ‚úì",
            "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" => "–í –ü–£–¢–ò",
            "–í–æ–∑–≤—Ä–∞—Ç" => "–í–û–ó–í–†–ê–¢",
            "–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç" => "–ß–ê–°. –í–û–ó–í–†–ê–¢",
            _ => status
        };
    }

    private string GetProductStatusBadgeClass(string status)
    {
        return status switch
        {
            "–í –Ω–∞–ª–∏—á–∏–∏" => "bg-success",
            "–û–∂–∏–¥–∞–µ—Ç—Å—è" => "bg-warning",
            "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" => "bg-info",
            "–ü—Ä–æ–¥–∞–Ω–æ" => "bg-primary",
            _ => "bg-secondary"
        };
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã
    private class SaleInfo
    {
        public string Buyer { get; set; } = string.Empty;
        public DateTime? SaleDate { get; set; }
        public decimal TotalAmount { get; set; }
        public int ProductCount { get; set; }
        public string Status { get; set; } = string.Empty;
    }

    private class CategoryStat
    {
        public string CategoryName { get; set; } = string.Empty;
        public int Count { get; set; }
        public double Percentage { get; set; }
    }

    private class AnalyticsData
    {
        public string Label { get; set; } = string.Empty;
        public decimal Balance { get; set; }
        public decimal Revenue { get; set; }
        public decimal Profit { get; set; }
        public decimal Margin { get; set; }
        public decimal Costs { get; set; }
        public int Units { get; set; }
        public int Returns { get; set; }
        public int Defective { get; set; }
    }
}
