@page "/password-check"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using bryx_CRM.Data.Models
@using bryx_CRM.Data
@using System.ComponentModel.DataAnnotations
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</PageTitle>

<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-dark text-white">
            <h3>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
            <p class="mb-0 small">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —É—á—ë—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π —Å–∏—Å—Ç–µ–º—ã</p>
        </div>
        <div class="card-body">
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success alert-dismissible fade show">
                    ‚úÖ @successMessage
                    <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
                </div>
            }

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show">
                    ‚ùå @errorMessage
                    <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
                </div>
            }

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="mb-3">
                <button class="btn btn-primary" @onclick="ShowAddUserModal">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                </button>
            </div>

            @if (users == null)
            {
                <p><em>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</em></p>
            }
            else if (!users.Any())
            {
                <div class="alert alert-warning">
                    ‚ö†Ô∏è –í —Å–∏—Å—Ç–µ–º–µ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong><br/>
                    –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong>@currentUserEmail</strong><br/>
                    –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <strong>@users.Count</strong>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Email</th>
                                <th>–ü–æ–ª–Ω–æ–µ –∏–º—è</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                                <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in users)
                            {
                                var isCurrentUser = user.Email?.Equals(currentUserEmail, StringComparison.OrdinalIgnoreCase) ?? false;
                                <tr class="@(isCurrentUser ? "table-info" : "")">
                                    <td>
                                        @user.Email
                                        @if (isCurrentUser)
                                        {
                                            <span class="badge bg-info">–í—ã</span>
                                        }
                                    </td>
                                    <td>@user.FullName</td>
                                    <td>
                                        <small>@user.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        @if (user.LastLoginAt.HasValue)
                                        {
                                            <small>@user.LastLoginAt.Value.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</small>
                                        }
                                        else
                                        {
                                            <small class="text-muted">–ù–∏–∫–æ–≥–¥–∞</small>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(user.PasswordHash))
                                        {
                                            <span class="badge bg-success">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">‚ùå –ù–µ—Ç –ø–∞—Ä–æ–ª—è</span>
                                        }
                                        @if (user.LockoutEnd.HasValue && user.LockoutEnd > DateTimeOffset.UtcNow)
                                        {
                                            <span class="badge bg-warning">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                                        }
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" @onclick="() => ShowChangePasswordModal(user)">
                                            üîë –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                                        </button>
                                        @if (!isCurrentUser)
                                        {
                                            <button class="btn btn-sm btn-danger" @onclick="() => ShowDeleteConfirmation(user)">
                                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-secondary" disabled title="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–µ–±—è">
                                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <hr />

                <div class="card bg-light">
                    <div class="card-body">
                        <h5>üîê –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:</h5>
                        <ul>
                            <li><strong>–ê–ª–≥–æ—Ä–∏—Ç–º —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> PBKDF2-HMAC-SHA256</li>
                            <li><strong>–ò—Ç–µ—Ä–∞—Ü–∏–∏:</strong> 10,000</li>
                            <li><strong>–ó–∞—â–∏—Ç–∞:</strong> –ö–∞–∂–¥—ã–π –ø–∞—Ä–æ–ª—å –∏–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å–æ–ª—å</li>
                            <li><strong>–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞:</strong> –ü–æ—Å–ª–µ 5 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞</li>
                        </ul>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è -->
@if (showPasswordModal && selectedUser != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üîë –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è @selectedUser.Email</h5>
                    <button type="button" class="btn-close" @onclick="ClosePasswordModal"></button>
                </div>
                <EditForm Model="@passwordModel" OnValidSubmit="ChangePassword">
                    <DataAnnotationsValidator />
                    <div class="modal-body text-dark bg-white">
                        <div class="mb-3">
                            <label class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                            <InputText type="password" class="form-control" @bind-Value="passwordModel.NewPassword" />
                            <ValidationMessage For="@(() => passwordModel.NewPassword)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                            <InputText type="password" class="form-control" @bind-Value="passwordModel.ConfirmPassword" />
                            <ValidationMessage For="@(() => passwordModel.ConfirmPassword)" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="ClosePasswordModal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary" disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span>‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>
                            }
                            else
                            {
                                <span>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
@if (showAddUserModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
                    <button type="button" class="btn-close" @onclick="CloseAddUserModal"></button>
                </div>
                <EditForm Model="@newUserModel" OnValidSubmit="AddUser">
                    <DataAnnotationsValidator />
                    <div class="modal-body text-dark bg-white">
                        <div class="mb-3">
                            <label class="form-label">Email:</label>
                            <InputText type="email" class="form-control" @bind-Value="newUserModel.Email" />
                            <ValidationMessage For="@(() => newUserModel.Email)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ü–æ–ª–Ω–æ–µ –∏–º—è:</label>
                            <InputText class="form-control" @bind-Value="newUserModel.FullName" />
                            <ValidationMessage For="@(() => newUserModel.FullName)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ü–∞—Ä–æ–ª—å:</label>
                            <InputText type="password" class="form-control" @bind-Value="newUserModel.Password" />
                            <ValidationMessage For="@(() => newUserModel.Password)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                            <InputText type="password" class="form-control" @bind-Value="newUserModel.ConfirmPassword" />
                            <ValidationMessage For="@(() => newUserModel.ConfirmPassword)" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseAddUserModal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary" disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span>‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...</span>
                            }
                            else
                            {
                                <span>‚ûï –°–æ–∑–¥–∞—Ç—å</span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
@if (showDeleteModal && selectedUser != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h5>
                    <button type="button" class="btn-close" @onclick="CloseDeleteModal"></button>
                </div>
                <div class="modal-body text-dark bg-white">
                    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?</p>
                    <p><strong>Email:</strong> @selectedUser.Email</p>
                    <p><strong>–ò–º—è:</strong> @selectedUser.FullName</p>
                    <p class="text-danger"><strong>‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDeleteModal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteUser" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span>‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ...</span>
                        }
                        else
                        {
                            <span>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .modal.show {
        display: block;
    }

    .table-info {
        background-color: rgba(13, 110, 253, 0.1);
    }

    .btn-sm {
        margin-right: 5px;
    }
</style>

@code {
    private List<ApplicationUser>? users;
    private string? currentUserEmail;
    private string? successMessage;
    private string? errorMessage;
    private bool isLoading = false;

    // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
    private bool showPasswordModal = false;
    private bool showAddUserModal = false;
    private bool showDeleteModal = false;
    private ApplicationUser? selectedUser = null;

    // –ú–æ–¥–µ–ª–∏ —Ñ–æ—Ä–º
    private PasswordChangeModel passwordModel = new();
    private NewUserModel newUserModel = new();

    protected override async Task OnInitializedAsync()
    {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserEmail = authState.User.Identity?.Name;

        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        await using var context = await DbContextFactory.CreateDbContextAsync();
        users = await context.Users
            .OrderBy(u => u.Email)
            .ToListAsync();
    }

    // === –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è ===
    private void ShowChangePasswordModal(ApplicationUser user)
    {
        selectedUser = user;
        passwordModel = new PasswordChangeModel();
        showPasswordModal = true;
    }

    private void ClosePasswordModal()
    {
        showPasswordModal = false;
        selectedUser = null;
        passwordModel = new();
    }

    private async Task ChangePassword()
    {
        if (selectedUser == null) return;

        isLoading = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var user = await UserManager.FindByIdAsync(selectedUser.Id);
            if (user == null)
            {
                errorMessage = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω";
                return;
            }

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π (admin reset)
            var token = await UserManager.GeneratePasswordResetTokenAsync(user);
            var result = await UserManager.ResetPasswordAsync(user, token, passwordModel.NewPassword);

            if (result.Succeeded)
            {
                successMessage = $"–ü–∞—Ä–æ–ª—å –¥–ª—è {user.Email} —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω";
                ClosePasswordModal();
                await LoadUsers();
            }
            else
            {
                errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"–û—à–∏–±–∫–∞: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    // === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
    private void ShowAddUserModal()
    {
        newUserModel = new NewUserModel();
        showAddUserModal = true;
    }

    private void CloseAddUserModal()
    {
        showAddUserModal = false;
        newUserModel = new();
    }

    private async Task AddUser()
    {
        isLoading = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var user = new ApplicationUser
            {
                UserName = newUserModel.Email,
                Email = newUserModel.Email,
                FullName = newUserModel.FullName,
                EmailConfirmed = true,
                CreatedAt = DateTime.UtcNow
            };

            var result = await UserManager.CreateAsync(user, newUserModel.Password);

            if (result.Succeeded)
            {
                successMessage = $"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.Email} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω";
                CloseAddUserModal();
                await LoadUsers();
            }
            else
            {
                errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"–û—à–∏–±–∫–∞: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    // === –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
    private void ShowDeleteConfirmation(ApplicationUser user)
    {
        selectedUser = user;
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        selectedUser = null;
    }

    private async Task DeleteUser()
    {
        if (selectedUser == null) return;

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–µ–±—è
        if (selectedUser.Email?.Equals(currentUserEmail, StringComparison.OrdinalIgnoreCase) ?? false)
        {
            errorMessage = "–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!";
            CloseDeleteModal();
            return;
        }

        isLoading = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var user = await UserManager.FindByIdAsync(selectedUser.Id);
            if (user == null)
            {
                errorMessage = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω";
                return;
            }

            var result = await UserManager.DeleteAsync(user);

            if (result.Succeeded)
            {
                successMessage = $"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.Email} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω";
                CloseDeleteModal();
                await LoadUsers();
            }
            else
            {
                errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"–û—à–∏–±–∫–∞: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    // === –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö ===
    public class PasswordChangeModel
    {
        [Required(ErrorMessage = "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å")]
        [MinLength(6, ErrorMessage = "–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å")]
        [Compare(nameof(NewPassword), ErrorMessage = "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    public class NewUserModel
    {
        [Required(ErrorMessage = "Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω")]
        [EmailAddress(ErrorMessage = "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "–ü–æ–ª–Ω–æ–µ –∏–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ")]
        public string FullName { get; set; } = string.Empty;

        [Required(ErrorMessage = "–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω")]
        [MinLength(6, ErrorMessage = "–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤")]
        public string Password { get; set; } = string.Empty;

        [Required(ErrorMessage = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å")]
        [Compare(nameof(Password), ErrorMessage = "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
